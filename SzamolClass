using System;
using System.Collections.Generic;
using System.Linq;

namespace Dhondt
{
    /// <summary>
    /// Ez a class tartalmaz minden számítást ami a mandátumkiosztáshoz kapcsolódik. Ha a végeredményt szeretnénk akkor elég
    /// a Cserelget()-et használni mivel ez kiadja a pártok nevét és mellé a mandátumuk számát.
    /// </summary>
    public class Szamol
    {
        private Partok p;

        /// <summary>
        /// Számol osztály konstruktora, példányosítja a Partok objektumot az adott fájlnévvel.
        /// </summary>
        public Szamol(string fajlNev)
        {
            p = new Partok(fajlNev);
        }

        /// <summary>
        /// Számítja és visszaadja azoknak a pártoknak a listáját, amelyek átlagos szavazataránya meghaladja a megadott küszöbértéket.
        /// </summary>
        /// <returns>A megadott küszöbértéket meghaladó átlagos szavazataránnyal rendelkező pártok listája.</returns>
        public List<string> KuszobSzamit()
        {
            double sum = p.Parts.Sum(part => part.SzavazatSzam);
            return p.Parts.Where(part => Math.Round((double)part.SzavazatSzam / sum * 100) >= part.Szazalek).Select(part => part.PartNev).ToList();
        }

        /// <summary>
        /// Visszaadja azon pártok neveit, amelyek kedvezményben részesülnek.
        /// </summary>
        /// <returns>A kedvezményben részesülő pártok neveinek listája.</returns>
        public List<string> Kedvezmenyesek() => p.Parts.Where(part => part.Nemzete == 1).Select(part => part.PartNev).ToList();

        /// <summary>
        /// Kiosztja a mandátumokat a partok között az oszlopok alapján.
        /// </summary>
        /// <returns>A mandátumok eloszlása a partok között az oszlopok alapján.</returns>
        public List<(int, string)> MandatumKioszt() => p.Parts.SelectMany(part => part.oszlop.Select(item => (item.Item1, part.PartNev))).OrderByDescending(x => x.Item1).Take(Partok.Mandatum).ToList();

        /// <summary>
        /// Válogat az új kedvezményezettek közül az átlagos szavazatarány alapján.
        /// </summary>
        /// <returns>Az átlagos szavazataránnyal rendelkező új kedvezményezettek listája.</returns>
        public List<string> UjKedvezemenyezett()
        {
            List<string> kuszob = KuszobSzamit();
            List<string> kedvezmenyesek = Kedvezmenyesek();
            return kedvezmenyesek.Where(kedv => kuszob.Contains(kedv)).ToList();
        }

        /// <summary>
        /// Kiválasztja azokat a pártokat, amelyek kedvezményezettek és nincsenek jelen a mandátumosok között.
        /// </summary>
        /// <returns>Azoknak a pártoknak a listája, amelyek kedvezményezettek és nincsenek jelen a mandátumosok között.</returns>
        public List<string> Cserenevek()
        {
            List<string> kedvezmenyesek = UjKedvezemenyezett();
            List<(int, string)> mandatumosok = MandatumKioszt();
            return kedvezmenyesek.Where(kedv => !mandatumosok.Any(mand => mand.Item2 == kedv)).Distinct().ToList();
        }

        /// <summary>
        /// Ellenőrzi, hogy van-e kiváltságos párt és ennek megfelelően elosztja a mandátumokat.
        /// </summary>
        /// <returns>(Mandátumok száma,pártnév)</returns>
        public List<(int, string)> Cserelget()
        {
            List<string> csere = Cserenevek();
            List<(int, string)> mandatumosok = MandatumKioszt().Take(10 - csere.Count).ToList();
            var maxValues = csere.Select(kp =>
            {
                int max = p.Parts.Find(x => x.PartNev == kp).oszlop.Select(x => x.Item1).Max();
                return (max, kp);
            });
            mandatumosok.AddRange(maxValues);
            return mandatumosok;
        }
    }
}
